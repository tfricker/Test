---
title: "Casualty Risk Model"
author: "Tyler Fricker"
date: "3/27/2018"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Load packages.
```{r}
library(ggplot2)
library(dplyr)
library(lubridate)
library(sf)
```

Import `SocialCorrelates.shp` containing the casualty-producing tornadoes since 1995 and estimates of socioeconomic and demographic data at the tornado level. Add `Date` and `hr` columns.
```{r}
unzip("SocialCorrelates.zip")
Tor.sfdf <- st_read(dsn = "SocialCorrelates", 
                    layer = "SocialCorrelates", 
                    stringsAsFactors = FALSE) %>%
  mutate(Date = as.Date(date),
         hr = hour(DateTim))
```

### Data Analysis

Preliminary analysis
```{r}
as.data.frame(Tor.sfdf) %>%
  filter(cas > 0) %>%
  summarize(meanCas = mean(cas),
            varCas = var(cas),
            ratio = varCas/meanCas)
```

Given the large disparity between the mean and variance of casualties the casualty counts are over-dispersed relative to a Poisson distribution. This suggests that a negative binomial (or log normal) distribution may be a reasonable likelihood model.

The number of tornadoes and the number of casualties conditional on at least one mobile home. 
```{r}
as.data.frame(Tor.sfdf) %>%
  group_by(MoblHms >= 1) %>%
  summarize(nC = sum(cas),
            nT = n())
```
About 13% of all tornado casualties occurred in areas estimated to have at least one mobile home.

Look at trends in annual tornado casualties and casualty producing tornadoes.
```{r}
dfY <- Tor.sfdf %>%
  group_by(yr) %>%
  summarize(nCas = sum(cas),
            ncT = n())
  
ggplot(dfY, aes(x = yr, y = nCas)) +
  geom_point() +
  geom_smooth(method = lm) +
  scale_x_continuous(breaks = seq(1995, 2016, 2)) +
  xlab("Year") + ylab("Number of Tornado Casualties") +
  theme_minimal()

ggplot(dfY, aes(x = yr, y = ncT)) +
  geom_point() +
  geom_smooth(method = lm) +
  scale_x_continuous(breaks = seq(1995, 2016, 2)) +
  scale_y_continuous(limits = c(0, NA)) +
  xlab("Year") + ylab("Number of Casualty-Producing Tornadoes") +
  theme_minimal()
```

Look at trends in monthly tornado casualties. I think this is better as points +/- 2 s.e.
```{r}
dfM <- Tor.sfdf %>%
  group_by(mo) %>%
  summarize(nT = n(),
            nCas = sum(cas),
            perTorCas = nCas/nT) %>%
  mutate(MonthF = factor(month.abb[mo], levels = month.abb))

ggplot(dfM, aes(x = mo, y = perTorCas)) +
  geom_point() +
  geom_smooth() +
  scale_x_continuous(breaks = seq(1,12), labels = dfM$MonthF) +
  xlab("Month") + ylab("Average Tornado Casualties") +
  theme_minimal()

ggplot(dfM, aes(x = MonthF, y = nCas)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(limits = c(0, 10000)) +
  xlab("") + ylab("Number of Tornado Casualties") +
  theme_minimal()
```

Look at trends in hourly tornado casualties.
```{r}
dfH <- Tor.sfdf %>%
  group_by(hr) %>%
  summarize(nT = n(),
            nCas = sum(cas),
            perTorCas = nCas/nT)

ggplot(dfH, aes(x = hr, y = perTorCas)) +
  geom_point() +
  geom_smooth() +
  xlab("Hour") + ylab("Average Tornado Casualties") +
  theme_minimal()

ggplot(dfH, aes(x = hr, y = nCas)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks = seq(0, 24, 4), labels = c("12:00AM", "4:00AM", "8:00AM", "12:00PM", "4:00PM", "8:00PM", "")) +
  scale_y_continuous(limits = c(0, 4500)) +
  xlab("") + ylab("Number of Tornado Casualties") +
  theme_minimal()
```

Create a new data frame with columns containing logged and scaled variables.
```{r}
df <- as.data.frame(Tor.sfdf) %>%
  mutate(lpopD = log(popD2),
         lED = log(ED),
         lcas = log(cas),
         smi = scale(MdnIncm),
         smh = scale(MoblHms),
         syr = scale(Year),
         pW = WhitPpl/TotlPpl,
         pB = BlckPpl/TotlPpl,
         plot_date = as.Date(format(Date, "2016-%m-%d")))
```

Year/date plot. Code from: https://buzzfeednews.github.io/2018-07-wildfire-trends/
```{r}
ggplot(df, aes(y = Year)) +
  geom_hline(yintercept = seq(1995, 2016, by = 1), color = "gray", size = .05) +
  scale_size_area(max_size = 10, breaks = c(0, 2, 4, 6), labels = c("1", "7", "55", "403"), name = "Tornado\nCasualties") +
  scale_x_date(date_breaks = "months", date_labels = "%b") +
  scale_y_reverse(limits = c(2016, 1995), breaks = c(2015, 2010, 2005, 2000, 1995)) +
  xlab("") +  ylab("") +
  geom_point(aes(size = lcas, x = plot_date), color = "#d397fc", alpha = .5) +
  theme_minimal()
```


### Models

Here we extend the model of Elsner et al. (2018) to include a trend term to account for the steady improvement in warning residents that results in a tendency toward fewer casualties. Based on previous research showing a greater risk of casualties for residents in mobile homes we include a term to account for the number of mobile homes estimated within the path.

Try two fixed effects models.
```{r}
library(MASS)
formula1 <- cas ~ syr + lpopD + lED + lpopD:lED + smh
formula2 <- lcas ~ syr + lpopD + lED + lpopD:lED + smh

m1 <- glm.nb(formula1, link = log, data = df)
m2 <- lm(formula2, data = df)

summary(m1)
summary(m2)

cor(df$cas, exp(predict(m1)))
cor(df$cas, exp(predict(m2)))
```

Try some mixed effects models.
```{r}
library(lme4)

formula4 <- lcas ~ syr + lpopD + lED + lpopD:lED + smh + smi + (1|mo) + (1|hr)
m4 <- lmer(formula4, data = df)

summary(m4)
cor(df$cas, exp(predict(m4)))
```

Work with the **brms** package for mixed effects model. Set `inits` to `"0"` rather than the default `"random"`.
```{r}
library(brms)

formula5 <- cas | trunc(lb = 1) ~ syr + lpopD + lED + lpopD:lED + smh + (1|hr) + (1|mo)
get_prior(formula5, data = df, family = lognormal)

m5 <- brm(formula = formula5,
          data = df, family = lognormal,
          prior = c(set_prior("normal(0,5)", class = "b"),
                    set_prior("student_t(3, 3, 10)", class = "Intercept"),
                    set_prior("student_t(3, 0, 10)", class = "sd"),
                    set_prior("student_t(3, 0, 10)", class = "sigma")),
          warmup = 500, iter = 2000, chains = 2, inits = "0",
          control = list(adapt_delta = .8))

summary(m5)
```

Correlation between estimated and actual casualties.
```{r}
cor(predict(m5)[, 1], df$cas)
```

The `posterior_predict()` function generates 3000 samples of cas. Compare the distribution of cas statistics (mean, max) with actual cas.

```{r}
yrep <- posterior_predict(m5)
df.yrep <- as.data.frame(yrep)
df.out <- reshape2::melt(df.yrep) %>%
  group_by(variable) %>%
  summarize(mx = max(value),
            mn = exp(mean(log(value))))

quantile(df.out$mn, probs = c(.25, .75), na.rm = TRUE)
quantile(df.out$mx, probs = c(.25, .75), na.rm = TRUE)
```

Look at the posterior predictive checks.
```{r}
ggplot(df.out, aes(mn)) + 
  geom_density(fill = "red", color = "red") +
  geom_vline(xintercept = exp(mean(log(df$cas))), color = "black", size = 1) +
  scale_x_log10(breaks = c(1, 10, 100, 1000), limits = c(1, 1000)) +
  ylab("Posterior Density") +
  xlab("Average Per-Tornado Casualty Rate") +
  theme_minimal()

ggplot(df.out, aes(mx)) + 
  geom_density(fill = "red", color = "red") +
  geom_vline(xintercept = max(df$cas), color = "black", size = 1) +
  scale_x_log10(breaks = c(100, 1000, 10000, 100000), labels = c(100, 1000, 10000, "100,000")) + 
  ylab("Posterior Density") +
  xlab("Maximum Per-Tornado Casualty Rate") +
  theme_minimal()
```

```{r}
coefTable <- as.data.frame(summary(m5)$fixed) %>%
  mutate(lb = `l-95% CI`,
         ub = `u-95% CI`,
         mi = `Estimate`,
         id = 1:6) %>%
  filter(id %in% c(2, 5, 6)) %>%
  mutate(id2 = 1:3)

ggplot(coefTable, aes(x = id2, y = mi)) +
  geom_hline(yintercept = 0, color = "grey", linetype = "solid") +
  geom_hline(yintercept = c(-.6, -.3, .3), color = "grey", linetype = "dashed") +
  geom_point() +  
  geom_errorbar(aes(x = id2, ymin = lb, ymax = ub), col = "red", width = 0, size = 2) +
  geom_point() +
  scale_x_reverse(breaks = 1:3, labels = c("Trend", "Mobile Homes", "Interaction")) +
  ylab("Fixed Effects") + xlab("") +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  coord_flip() 
```

Save the predicted values and their uncertainties as a data frame. Include additional columns from `Tor.sfdf` for identifying the case (tornado).
```{r}
predValues.df <- as.data.frame(predict(m5)) %>%
  mutate(Actual = df$cas, 
         Diff = Actual - Estimate,
         om = Tor.sfdf$om, 
         Date = Tor.sfdf$Date, 
         st = Tor.sfdf$st)

predValues.sfdf <- st_sf(predValues.df, 
                         geometry = Tor.sfdf)
```

### Tornado casualties and place

Using the `predict()` function, look at over- and under-predictions of casualties by tornado. Remove the `yr` and `sm` variables from the data.frame, as `dplyr` will not run with the scaled variables.
```{r}
df.pre <- df %>%
  dplyr::select(-one_of("yr", "smh")) %>%
  dplyr::mutate(pre = predict(m5)[, 1],
                differ = cas - pre)

ggplot(df.pre, aes(x = cas, y = pre)) +
  geom_point() +
  geom_abline(slope = 1) + 
  xlab("Observed Number of Casualties") +
  ylab("Predicted Rate") +
  scale_x_log10() + scale_y_log10() +
  geom_text(data=subset(df.pre, cas >= 50),
            aes(label = st), hjust = 1.2, vjust = .85)
```

Top 10 over-predictions of tornado casualties.
```{r}
OverPre <- df.pre %>%
  arrange(round(differ))

OverPre[1:10,]
```

Over-Predictions:
1) Detroit, MI tornado
2) Hackleburg–Phil Campbell, AL tornado
3) Nashville, TN tornado
4) Anderson Hills (Hunstville), AL tornado
5) St. Louis County, MO tornado
6) Bridge Creek–Moore, OK tornado
7) Wichita, KS tornado
8) Little Rock, AR tornado
9) Louisville, KY tornado
10) South Bend, IN tornado

Top 10 under predictions
```{r}
UnderPre <- df.pre %>%
  arrange(desc(differ))

UnderPre[1:10,]
```

Under-Predictions
1) Joplin, MO tornado
2) Tuscaloosa-Birmingham, AL tornado
3) Garland-Rowlett, TX tornado
4) Gainesville, GA tornado
5) Camilla, GA tornado (2000)
6) Camilla, GA tornado (2003)
7) Picher,OK tornado
8) Spencer, SD tornado
9) Madisonville, KY tornado
10) Ringgold, GA tornado


### Assumptions

```{r}
summary(m1)
pchisq(2255, 2192, lower.tail = FALSE) # model is not adequate (p-value > .05)
```

Observed number of casualties versus predicted rate.
```{r, eval=FALSE}
df.glm = st_sf(om = sfdf$om, date = sfdf$Date, state = sfdf$st, obs = sfdf$cas, pre = modelFE$fitted.values, geometry = sfdf$geometry) %>%
  mutate(differ = obs - pre)

cor(df.glm$obs, df.glm$pre)

df.glm2 = st_sf(om = sfdf$om, date = sfdf$Date, state = sfdf$st, obs = sfdf$cas, pre = exp(fitted.values(modelME)), geometry = sfdf$geometry) %>%
  mutate(differ = obs - pre)

cor(df.glm2$obs, df.glm2$pre)

df.nb = st_sf(om = sfdf$om, date = sfdf$Date, state = sfdf$st, EF = sfdf$mag, obs = sfdf$cas, pre = fitted.values(modelNB), geometry = sfdf$geometry) %>%
  mutate(differ = obs - pre)

cor(df.nb$obs, df.nb$pre)

ggplot(df.nb, aes(x = obs, y = pre)) +
  geom_point() +
  geom_abline(slope = 1) + 
  xlab("Observed Number of Casualties") +
  ylab("Predicted Rate") +
  scale_x_log10() + scale_y_log10() +
  geom_text(data=subset(df.nb, obs >= 30),
            aes(label = state), hjust = 1, vjust = .5)

df.S = st_sf(om = sfdf$om, date = sfdf$Date, state = sfdf$st, EF = sfdf$mag, obs = sfdf$cas, pre = fitted(modelS)[,1], geometry = sfdf$geometry) %>%
  mutate(differ = obs - pre)

cor(df.S$obs, df.S$pre)

ggplot(df.S, aes(x = obs, y = pre)) +
  geom_point() +
  geom_abline(slope = 1) + 
  xlab("Observed Number of Casualties") +
  ylab("Predicted Rate") +
  scale_x_log10() + scale_y_log10() +
  geom_text(data=subset(df.S, obs >= 30),
            aes(label = state), hjust = 1.2, vjust = .85)
```

Look for cases of extreme difference by state.


-----------------------------------
Camilla, GA

Camilla is a city in Mitchell County, GA with a population of 5,360 as of the 2010 Census. The racial makeup of the city is roughly 65% African American, 32% White. The median household income in the city is \$22,485 and the per capita income for the city is \$13,117. About 35% of families and 38% of the total population are below the poverty line.

Camilla was hit by two significant tornadoes in the early 2000s, both occurring in the early morning and both traveling through the southeast side of the city. The first tornado (EF3) occurred on February 14, 2000 and resulted in 206 casualties. It tore through two major subdivisions and four mobile home parks just south of Camilla. Reports show 200 homes were destroeyd in the tornado, with another 250 homes damaged. The second tornado (EF3) occurred on March 20, 2003 and resulted in 186 casualties. It took a similar path to the 2000 tornado, destroying 66 homes and damaging another 200.

Reasons for the high casualty count are not entirely known. Camilla's warning system includes tornado sirens along with watches and warnings from the National Weather Service. The city does suffer from a higher percentage of low-income residents, which indicates poor housing quality. In addition, Camilla has a long history of racial segreggation and tension, highlighted by the fact that a fence separating white and black graves at the local cemetary was removed in 2017 (about 40 years after the Civil Rights Act (1968) was passed).

### Find discrimination indices here (http://enceladus.isr.umich.edu/race/racestart.asp)

The model also overperditcs the Grovetown-Augusta, GA tornado (2009-04-10) by 65 casualties, while it underpredicts the Gainesville area, GA tornado (1998-03-20) by more than 100 casualties 174.

Demographics of Grovetown: 71\% white and 20\% black. Household median income at $33,382. The index of discrimination was 44.7.
Demographics of Augusta, GA: 39.1\% white and 54.7\% black. Household median income at $37,231. The index of discrimination was 44.7.

Demographics of Gainesville, GA: 54.2\% white and 15.2\% black (41.6\% hispanic or latino). Household median income at $38,119. The index of discrimination was 65.

The model overpredicts the Clinton-Jackson, MS tornado (2011-04-15) by 44 casualties, while the model underpredicts the Columbia, MS tornado (2014-12-23) by about the same amount (32).

Demographics for Clinton, MS: 60\% white and 33.9\% black. Household median income $56,539. The index of discrimination was 61.5.
Demographics for Jackson, MS: 18.4\% white and 79\% black. Household median income at $30,414. The index of discrimination was 61.5.

Demographics for Columbia, MS: 62.6\% whilte and 35.64\% black. Household median income at $19,644. The index of discrimination was 53.5. 

The largest underprediction in the model is the Tuscaloosa-Birmingam, AL tornado (2011-04-27) at 1,384 people.

The index of discrimination was 53.4 (Tuscaloosa Metro) and 70.3 (Birmingham Metro).

### Table of Over/Under-predicted casualties and covariates

Location & Date & Over/Under (Difference) & Index of Discrimination (0-100) \\

Grovetown-Augusta, GA & 2009-04-10 & Over (85) & 44.7 \\
Clinton-Jackson, MS & 2011-04-15 & Over (23) & 61.5 \\
Marion County, FL & 1995-01-07 & Over (6) & 49.6 \\
Van Wert, OH & 2002-11-10 & Over (19) & 37.0 \\
Waynesboro, TN & 2015-12-23 & Over (25) & 54.6 \\
Anderson Hills, AL & 1995-05-18 & Over (121) & 54.6 \\

Average Index of Discrimination: 50.3


Gainesville, GA & 1998-03-20 & Under (170) & 65.0 \\
Columbia, MS & 2014-12-23 & Under (30) & 53.5 \\
Tuscaloosa-Birmingam, AL & 2011-04-27 & Under (1115) & 61.9 \\
Arab-Joppa, AL & 1995-02-16 & Under (94) & 54.6 \\
Murfreesboro, TN & 2002-04-28 & Under (24) & 57.4 \\
Rowlett, TX & 2015-12-26 & Under (421) & 59.8 \\

Average Index of Discrimination: 58.7

Map of the top 10 underpredicted tornadoes
```{r}
#download.file("http://www2.census.gov/geo/tiger/GENZ2015/shp/cb_2015_us_state_20m.zip", destfile = "states.zip")
#unzip("states.zip")

us_geo <- read_shape("cb_2015_us_state_20m.shp", as.sf = TRUE, stringsAsFactors = FALSE)
us_geo = subset(us_geo, !(NAME %in% c("Alaska", "Hawaii", "Puerto Rico")))
colnames(us_geo)[5] = "st"

us_geo = us_geo %>%
  dplyr::select("st", "NAME" ,"geometry")

df3 = df2 %>%
  arrange(desc(differ))

df3 = df3[1:20,]

A = tm_shape(us_geo, projection ="+init=epsg:2163") +
  tm_borders() +
  tm_shape(df3) +
  tm_bubbles("differ", col = "#31a354", sizes.legend = c(200, 600, 1000, 1400), alpha = 0.3, title.size="Underpredicted Casualties", scale = 5/3) + 
  tm_shape(us_geo) + 
  tm_borders(col = "grey", alpha = 0.3) +
  tm_format_Europe(legend.position = c("left", "bottom"),
                   attr.position = c("left", "bottom"),
                   legend.frame = FALSE) +
  tm_layout(frame = FALSE)

df4 = df2 %>%
  arrange(differ) %>%
  mutate(differ = abs(differ))

df4 = df4[1:20,]

B = tm_shape(us_geo, projection ="+init=epsg:2163") +
  tm_borders() +
  tm_shape(df4) +
  tm_bubbles("differ", col = "purple", sizes.legend = c(50, 100, 150, 200), alpha = 0.3, title.size="Overpredicted Casualties", scale = 2/3) + 
  tm_shape(us_geo) + 
  tm_borders(col = "grey", alpha = 0.3) +
  tm_format_Europe(legend.position = c("left", "bottom"),
                   attr.position = c("left", "bottom"),
                   legend.frame = FALSE) +
  tm_layout(frame = FALSE)

A = A + tm_style_white(title="A")
B = B + tm_style_white(title="B")

tmap_arrange(A, B, ncol = 1)
```

Plot the residuals
```{r}
plot(residuals(model))
```

### Sankey Flow Chart

Sankey flow chart
```{r}
df = Torn.df %>%
  mutate(ratioW = WhitePeople/TotalPeople,
         ratioB = BlackPeople/TotalPeople,
         WhiteCas = round(cas * ratioW),
         BlackCas = round(cas * ratioB))

sigmoid <- function(x_from, x_to, y_from, y_to, scale = 5, n = 100) {
  x <- seq(-scale, scale, length = n)
  y <- exp(x) / (exp(x) + 1)
  tibble(x = (x + scale) / (scale * 2) * (x_to - x_from) + x_from,
         y = y * (y_to - y_from) + y_from)
}

n_points <- 400
data <- tibble(from = rep(4, n_points),
               to = sample(1:4, n_points, TRUE),
               color = sample(c("A", "B"), n_points, TRUE)) 

sigmoid(0, 1, as.numeric(data[2, 1]), as.numeric(data[2, 2]), 
        n = 100, scale = 10) %>%
  ggplot(aes(x, y)) +
  geom_point()

p = sigmoid(0, 1, as.numeric(data[2, 1]), as.numeric(data[2, 2]),
             n = 100, scale = 10) %>%
  mutate(time = row_number()) %>%
  ggplot(aes(x, y, frame = time)) +
  geom_point()

gganimate(p)
```

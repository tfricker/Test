---
title: "Casualty Risk Model"
author: "Tyler Fricker/James B. Elsner"
date: "3/27/2018"
output: html_notebook
editor_options:
  chunk_output_type: console
---

Load packages.
```{r}
library(ggplot2)
library(dplyr)
library(lubridate)
library(sf)
```

Import `SocialCorrelates.shp` containing the casualty-producing tornadoes 1995-2016 and estimates of socioeconomic and demographic data at the tornado level. Add `Date` and `hr` columns to the data frame.
```{r}
unzip("SocialCorrelates.zip")
Tor.sfdf <- st_read(dsn = "SocialCorrelates", 
                    layer = "SocialCorrelates", 
                    stringsAsFactors = FALSE) %>%
  mutate(Date = as.Date(date),
         hr = hour(DateTim))
```

### Data Analysis

Preliminary analysis
```{r}
as.data.frame(Tor.sfdf) %>%
  filter(cas > 0) %>%
  summarize(meanCas = mean(cas),
            varCas = var(cas),
            ratio = varCas/meanCas)
```

Given the large disparity between the mean and variance of casualties the casualty counts are over-dispersed relative to a Poisson distribution. This suggests that a negative binomial (or log normal) distribution may be a reasonable likelihood model.

The number of tornadoes and the number of casualties conditional on at least one mobile home. 
```{r}
as.data.frame(Tor.sfdf) %>%
  group_by(MoblHms >= 1) %>%
  summarize(nC = sum(cas),
            nT = n())
```
About 13% of all tornado casualties occurred in areas estimated to have at least one mobile home.

Look at trends in annual tornado casualties and casualty-producing tornadoes.
```{r}
dfY <- Tor.sfdf %>%
  group_by(yr) %>%
  summarize(nCas = sum(cas),
            ncT = n())
  
ggplot(dfY, aes(x = yr, y = nCas)) +
  geom_point() +
  geom_smooth(method = lm) +
  scale_x_continuous(breaks = seq(1995, 2016, 2)) +
  xlab("Year") + ylab("Number of Tornado Casualties") +
  theme_minimal()

ggplot(dfY, aes(x = yr, y = ncT)) +
  geom_point() +
  geom_smooth(method = lm) +
  scale_x_continuous(breaks = seq(1995, 2016, 2)) +
  scale_y_continuous(limits = c(0, NA)) +
  xlab("Year") + ylab("Number of Casualty-Producing Tornadoes") +
  theme_minimal()
```

Look at trends in monthly tornado casualties. Points +/- 2 s.e.
```{r}
dfM <- Tor.sfdf %>%
  group_by(mo) %>%
  summarize(nT = n(),
            nCas = sum(cas),
            perTorCas = nCas/nT) %>%
  mutate(MonthF = factor(month.abb[mo], levels = month.abb),
         ci = qt(0.975, df = nT - 1) * sd(perTorCas)/sqrt(nT))

ggplot(dfM, aes(x = mo, y = perTorCas)) +
  geom_point() +
  geom_errorbar(aes(ymin = perTorCas - ci, ymax = perTorCas + ci), width = .25) +
  scale_x_continuous(breaks = seq(1,12), labels = dfM$MonthF, minor_breaks = NULL) +
  scale_y_continuous(limits = c(0, 20)) +
  xlab("") + ylab("Casualty Rate") + 
  ggtitle(label = "Casualty Rate Per Casualty-Producing Tornado (U.S.)", subtitle = "1995-2016") +
  theme_minimal()

ggplot(dfM, aes(x = MonthF, y = nCas)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(limits = c(0, 10000)) +
  xlab("") + ylab("") +
  ggtitle(label = "Number of U.S. Tornado Casualties", subtitle = "1995-2016") +
  theme_minimal()
```

Look at trends in hourly tornado casualties.
```{r}
dfH <- Tor.sfdf %>%
  group_by(hr) %>%
  summarize(nT = n(),
            nCas = sum(cas),
            perTorCas = nCas/nT) %>%
  mutate(ci = qt(0.975, df = nT - 1) * sd(perTorCas)/sqrt(nT))

ggplot(dfH, aes(x = hr, y = perTorCas)) +
  geom_point() +
  geom_errorbar(aes(ymin = perTorCas - ci, ymax = perTorCas + ci), width = .25) +
  scale_x_continuous(breaks = seq(0, 24, 4), labels = c("12:00AM", "4:00AM", "8:00AM", "12:00PM", "4:00PM", "8:00PM", "")) +
  scale_y_continuous(limits = c(0, 20)) +
  xlab("") + ylab("Casualty Rate") +
  ggtitle(label = "Casualty Rate Per Casualty-Producing Tornado (U.S.)", subtitle = "1995-2016") +
  theme_minimal()

ggplot(dfH, aes(x = hr, y = nCas)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks = seq(0, 24, 4), labels = c("12:00AM", "4:00AM", "8:00AM", "12:00PM", "4:00PM", "8:00PM", "")) +
  scale_y_continuous(limits = c(0, 4500)) +
  xlab("") + ylab("") +
   ggtitle(label = "Number of U.S. Tornado Casualties", subtitle = "1995-2016") +
  theme_minimal()
```

Create a new data frame with columns containing logged and scaled variables.
```{r}
df <- as.data.frame(Tor.sfdf) %>%
  mutate(lpopD = log(popD2),
         lED = log(ED),
         lcas = log(cas),
         smi = scale(MdnIncm),
         smh = scale(MoblHms),
         syr = scale(Year),
         pW = WhitPpl/TotlPpl,
         pB = BlckPpl/TotlPpl,
         plot_date = as.Date(format(Date, "2016-%m-%d")))
```

Year/date plot. Code from: https://buzzfeednews.github.io/2018-07-wildfire-trends/
```{r}
A = ggplot(df, aes(y = Year)) +
  geom_hline(yintercept = seq(1995, 2016, by = 1), color = "gray", size = .05) +
  scale_size_area(max_size = 10, breaks = c(0, 2, 4, 6), 
                  labels = c("1", "7", "55", "403"), name = "Tornado\nCasualties") +
  scale_x_date(date_breaks = "months", date_labels = "%b") +
  scale_y_reverse(limits = c(2016, 1995), breaks = c(2015, 2010, 2005, 2000, 1995)) +
  xlab("") +  ylab("") +
  geom_point(aes(size = lcas, x = plot_date), color = "#fd8d3c", alpha = .5) +
  theme_minimal()
```

Year/hour plot.
```{r}
B = ggplot(df, aes(y = Year)) +
  geom_hline(yintercept = seq(1995, 2016, by = 1), color = "gray", size = .05) +
  scale_size_area(max_size = 10, breaks = c(0, 2, 4, 6), labels = c("1", "7", "55", "403"), name = "Tornado\nCasualties") +
  scale_x_continuous(breaks = seq(0, 24, 4), labels = c("12:00AM", "4:00AM", "8:00AM", "12:00PM", "4:00PM", "8:00PM", "")) +
  scale_y_reverse(limits = c(2016, 1995), breaks = c(2015, 2010, 2005, 2000, 1995)) +
  xlab("") +  ylab("") +
  geom_point(aes(size = lcas, x = hr), color = "#fd8d3c", alpha = .5) +
  theme_minimal()
```

Combine plots
```{r}
source("http://peterhaschke.com/Code/multiplot.R")
mat = matrix(c(1, 2), nrow = 2, byrow = TRUE)
A = A + ggtitle("A") + 
  theme(plot.title=element_text(hjust=0))
B = B + ggtitle("B") + 
  theme(plot.title=element_text(hjust=0))
multiplot(A, B, layout = mat)
```


### Models

Here we extend the model of Elsner et al. (2018) to include a trend term to account for the steady improvement in warning residents that results in a tendency toward fewer casualties. Based on previous research showing a greater risk of casualties for residents in mobile homes we include a term to account for the number of mobile homes estimated within the path.

Try two fixed effects models.
```{r}
library(MASS)
formula1 <- cas ~ syr + lpopD + lED + lpopD:lED + smh
formula2 <- lcas ~ syr + lpopD + lED + lpopD:lED + smh

m1 <- glm.nb(formula1, link = log, data = df)
m2 <- lm(formula2, data = df)

summary(m1)
summary(m2)

cor(df$cas, exp(predict(m1)))
cor(df$cas, exp(predict(m2)))
```

Try some mixed effects models.
```{r}
library(lme4)

formula4 <- lcas ~ syr + lpopD + lED + lpopD:lED + smh + smi + (1|mo) + (1|hr)
m4 <- lmer(formula4, data = df)

summary(m4)
cor(df$cas, exp(predict(m4)))
```

Observed vs predicted.
```{r}
df$pre <- exp(predict(m4))

library(ggrepel)
ggplot(df[df$cas >= 50, ], aes(x = cas, y = pre)) +
  geom_point(aes(size = TotlPpl)) +
  geom_text_repel(aes(label = paste(st, date)), size = 1.75) +
  geom_abline(slope = 1) + 
  geom_smooth(method = lm, se = FALSE) +
  xlab("Observed Number of Casualties") +
  ylab("Predicted Rate") +
  scale_x_log10() + scale_y_log10() +
  theme_minimal()
```

Work with the **brms** package for mixed effects model. First sample from the priors. Set `inits` to `"0"` rather than the default `"random"`.
```{r}
library(brms)

formula5 <- cas | trunc(lb = 1) ~ syr + lpopD + lED + lpopD:lED + smh + (1|hr) + (1|mo)
get_prior(formula5, data = df, family = lognormal)

# Sample from the priors
prior5 <- brm(formula = formula5,
              data = df, family = lognormal,
              prior = c(set_prior("normal(0,5)", class = "b"),
                    set_prior("student_t(3, 3, 10)", class = "Intercept"),
                    set_prior("student_t(3, 0, 10)", class = "sd"),
                    set_prior("student_t(3, 0, 10)", class = "sigma")),
          sample_prior = "only", seed = 9112,
          control = list(adapt_delta = .8))

out <- predict(prior5, probs = c(0, 1))


# Fit the model

post5 <- brm(formula = formula5,
             data = df, family = lognormal,
             prior = c(set_prior("normal(0,5)", class = "b"),
                       set_prior("student_t(3, 3, 10)", class = "Intercept"),
                       set_prior("student_t(3, 0, 10)", class = "sd"),
                       set_prior("student_t(3, 0, 10)", class = "sigma")),
              inits = "0", seed = 9112,
              control = list(adapt_delta = .8))

summary(post5)
```

Correlation between estimated and actual casualties.
```{r}
cor(predict(post5)[, 1], df$cas)
```

NOTE: For different seeds the correlation ranged from .48 to .54. May need to generate more samples.

The `posterior_predict()` function generates 3000 samples of cas. Compare the distribution of cas statistics (mean, max) with actual cas.

```{r}
yrep <- posterior_predict(post5)
df.yrep <- as.data.frame(yrep)
df.out <- reshape2::melt(df.yrep) %>%
  group_by(variable) %>%
  summarize(mx = max(value, na.rm = TRUE),
            mn = exp(mean(log(value), na.rm = TRUE)))

quantile(df.out$mn, probs = c(.25, .75), na.rm = TRUE)
quantile(df.out$mx, probs = c(.25, .75), na.rm = TRUE)
```

Look at the posterior predictive checks.
```{r}
ggplot(df.out, aes(mn)) + 
  geom_density(fill = "red", color = "red") +
  geom_vline(xintercept = exp(mean(log(df$cas))), color = "black", size = 1) +
  scale_x_log10(breaks = c(1, 10, 100, 1000), limits = c(1, 1000)) +
  ylab("Posterior Density") +
  xlab("Average Per-Tornado Casualty Rate") +
  theme_minimal()

ggplot(df.out, aes(mx)) + 
  geom_density(fill = "red", color = "red") +
  geom_vline(xintercept = max(df$cas), color = "black", size = 1) +
  scale_x_log10(breaks = c(100, 1000, 10000, 100000), labels = c(100, 1000, 10000, "100,000")) + 
  ylab("Posterior Density") +
  xlab("Maximum Per-Tornado Casualty Rate") +
  theme_minimal()
```

```{r}
coefTable <- as.data.frame(summary(post5)$fixed) %>%
  mutate(lb = `l-95% CI`,
         ub = `u-95% CI`,
         mi = `Estimate`,
         id = 1:6) %>%
  filter(id %in% c(2, 5, 6)) %>%
  mutate(id2 = 1:3)

ggplot(coefTable, aes(x = id2, y = mi)) +
  geom_hline(yintercept = 0, color = "grey", linetype = "solid") +
  geom_hline(yintercept = c(-.6, -.3, .3), color = "grey", linetype = "dashed") +
  geom_point() +  
  geom_errorbar(aes(x = id2, ymin = lb, ymax = ub), col = "red", width = 0, size = 2) +
  geom_point() +
  scale_x_reverse(breaks = 1:3, labels = c("Trend", "Mobile Homes", "Interaction")) +
  ylab("Fixed Effects") + xlab("") +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  coord_flip() 
```

Save the predicted values and their uncertainties as a data frame. Include additional columns from `Tor.sfdf` for identifying the case (tornado).
```{r}
predValues.df <- as.data.frame(predict(post5)) %>%
  mutate(Actual = df$cas,
         Diff = Actual - Estimate,
         Sign = Diff > 0,
         om = Tor.sfdf$om,
         Year = Tor.sfdf$Year,
         Date = Tor.sfdf$Date,
         st = Tor.sfdf$st,
         slat = Tor.sfdf$slat,
         slon = Tor.sfdf$slon)

predValues.sfdf <- st_sf(predValues.df, 
                         geometry = Tor.sfdf$geometry)
```

Over/Under prediction plot.
```{r}
library(ggridges)
ggplot(predValues.df[abs(predValues.df$Diff) < 100, ], 
       aes(x = Diff, y = Year, group = Year, height = ..density..)) +
     geom_density_ridges(scale = 3, color = "white") + 
     scale_y_reverse(breaks = seq(1995, 2015, 5)) +
     ylab("") + xlab("Actual - Predicted")

ggplot(predValues.df, aes(y = Year)) +
  geom_hline(yintercept = seq(1995, 2016, by = 1), color = "gray", size = .05) +
  scale_y_reverse(limits = c(2016, 1995), breaks = c(2015, 2010, 2005, 2000, 1995)) +
  xlab("") +  ylab("") +
  geom_point(aes(y = Year, x = Diff), data = predValues.df[predValues.df$Sign, ], color = 'green') +
  geom_point(aes(y = Year, x = Diff), data = predValues.df[!predValues.df$Sign, ], color = 'purple') +
  theme_minimal()

ggplot(predValues.df, aes(x = Actual, y = Estimate)) +
  geom_point() +
  geom_abline(slope = 1) + 
  xlab("Observed Number of Casualties") +
  ylab("Predicted Rate") +
  scale_x_log10() + scale_y_log10() +
  geom_text(data = subset(predValues.df, Actual >= 30),
            aes(label = st), hjust = 1, vjust = .5) +
  theme_minimal()

ggplot(predValues.df[predValues.df$Actual >= 25, ], aes(x = Actual, y = Estimate)) +
  geom_point() +
  #geom_text_repel(aes(label = paste(st, Date)), size = 1.75) +
  geom_abline(slope = 1) + 
  geom_smooth(method = lm, se = FALSE) +
  xlab("Observed Number of Casualties") +
  ylab("Predicted Rate") +
  scale_x_log10() + scale_y_log10() +
  theme_minimal()
```

Over/under prediction map.
```{r}
library(USAboundaries)
sts <- state.name[!state.name %in% c("Alaska", "Hawaii")]
stateBorders <- us_states(states = sts)


p1 <- ggplot() +
  geom_sf(data = stateBorders) +
  geom_point(data = predValues.df[predValues.df$Diff >= 0, ], aes(x = slon, y = slat, size = Diff), color = "#1b7837", alpha = .4) +
  scale_size_continuous(name = "Under\nPrediction", 
                        breaks = c(50, 100, 200, 400, 800), 
                        labels = c(50, 100, 200, 400, 800)) +
  xlab("") + ylab("") +
  theme_minimal()

p2 <- ggplot() +
  geom_sf(data = stateBorders) +
  geom_point(data = predValues.df[predValues.df$Diff < 0, ], aes(x = slon, y = slat, size = abs(Diff)), color = "purple", alpha = .3) +
  scale_size_continuous(name = "Over\nPrediction", 
                        breaks = c(50, 100, 500, 1000, 5000), 
                        labels = c(50, 100, 500, 1000, 5000)) +
  xlab("") + ylab("") +
  theme_minimal()

library(patchwork)
p1/p2
```

Using T-Map
```{r}
library(tmap)
tm_shape(stateBorders, projection ="+init=epsg:2163") +
  tm_borders() +
  tm_shape(predValues.sfdf[predValues.sfdf$Diff >= 0, ]) +
  tm_bubbles("Diff", col = "#1b7837", sizes.legend = c(50, 100, 500, 1000, 1500), alpha = 0.4, title.size="Under-Prediction", scale = 2.5) + 
  tm_shape(stateBorders) + 
  tm_borders(col = "grey", alpha = 0.3) +
  tm_format('World', legend.position = c("left", "bottom"),
                   attr.position = c("left", "bottom"),
                  legend.frame = FALSE) +
  #tm_format_Europe(legend.position = c("left", "bottom"),
  #                 attr.position = c("left", "bottom"),
  #                 legend.frame = TRUE) +
  tm_layout(frame = FALSE)
```


### Tornado casualties and place

Top 10 over-predictions of tornado casualties.
```{r}
arrange(predValues.df, Diff)[1:20, ]
```

Over-Predictions:
1) Hackleburg–Phil Campbell, AL tornado
2) Bridge Creek–Moore, OK tornado
3) Tuscaloosa-Birmigham, AL tornado
4) Detroit, MI tornado
5) Little Rock, AR tornado
6) Anderson Hills (Hunstville), AL tornado
7) Wichita, KS tornado
8) St. Louis County, MO tornado
9) Nashville, TN tornado
10) Lyons-Salina, KS tornado


Top 10 under predictions
```{r}
arrange(predValues.df, desc(Diff))[1:20, ]
```

Under-Predictions
1) Joplin, MO tornado
2) Garland-Rowlett, TX tornado
3) Gainesville, GA tornado
4) Camilla, GA tornado (2000)
5) Camilla, GA tornado (2003)
6) Spencer, SD tornado
7) Columbus County, NC, tornado
8) Smithville, MS/Shottsville, AL tornado
9) Copeville, TX tornado
10) Marmaduke, AR/Caruthersville, MO tornado

## Case studies

Camilla, GA

Camilla is a city in Mitchell County, GA with a population of 5,360 as of the 2010 Census. The racial makeup of the city is roughly 65% African American, 32% White. The median household income in the city is \$22,485 and the per capita income for the city is \$13,117. About 35% of families and 38% of the total population are below the poverty line.

Camilla was hit by two significant tornadoes in the early 2000s, both occurring in the early morning and both traveling through the southeast side of the city. The first tornado (EF3) occurred on February 14, 2000 and resulted in 186 casualties. It tore through two major subdivisions and four mobile home parks just south of Camilla. Reports show 200 homes were destroeyd in the tornado, with another 250 homes damaged. The second tornado (EF3) occurred on March 20, 2003 and resulted in 206 casualties. It took a similar path to the 2000 tornado, destroying 66 homes and damaging another 200.

Reasons for the high casualty count are not entirely known. Camilla's warning system includes tornado sirens along with watches and warnings from the National Weather Service. The city does suffer from a higher percentage of low-income residents, which indicates poor housing quality. In addition, Camilla has a long history of racial segreggation and tension, highlighted by the fact that a fence separating white and black graves at the local cemetary was removed in 2017 (about 40 years after the Civil Rights Act (1968) was passed).

```{r}
library("ggmap")
register_google(key = "AIzaSyB0y87AL2w1o37oLIml81mB5_GWaPgQk_Y")

camilla <- c(left = -84.6486, bottom = 30.8658, right = -83.7571, top = 31.6447)

map = get_googlemap("camilla georgia", zoom = 15, maptype = "terrain")

ggmap(map) +
  labs(x = NULL, y = NULL) +
  theme(legend.position = "none")
```


```{r}
library("ggmap")

georgia <- c(left = -90.2726, bottom = 25.0396 , right = -75.6719, top = 36.7543)
map <- get_stamenmap(georgia, 
                     zoom = 5, 
                     maptype = "toner", 
                     color = "bw")
ggmap(map) +
  labs(x = NULL, y = NULL) +
  theme(legend.position = "none",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
  
camilla <- c(left = -84.6486, bottom = 30.8658, right = -83.7571, top = 31.6447)
map <- get_stamenmap(camilla, 
                     #zoom = 2, 
                     maptype = "toner", 
                     color = "bw")
ggmap(map) +
  labs(x = NULL, y = NULL) +
  theme(legend.position = "none")
```

Add the tornado paths onto the map. Start with the 2000 tornado.
```{r}
Cam = Tor.sfdf[633,]
cam_3857 <- st_transform(Cam, 3857)

camilla2 <- c(left = -84.5000, bottom = 30.9000, right = -83.7571, top = 31.5000)
map <- get_stamenmap(camilla2, 
                     #zoom = 2, 
                     maptype = "toner", 
                     color = "bw")

# Define a function to fix the bbox to be in EPSG:3857
ggmap_bbox <- function(map) {
  if (!inherits(map, "ggmap")) stop("map must be a ggmap object")
  # Extract the bounding box (in lat/lon) from the ggmap to a numeric vector, 
  # and set the names to what sf::st_bbox expects:
  map_bbox <- setNames(unlist(attr(map, "bb")), 
                       c("ymin", "xmin", "ymax", "xmax"))

  # Coonvert the bbox to an sf polygon, transform it to 3857, 
  # and convert back to a bbox (convoluted, but it works)
  bbox_3857 <- st_bbox(st_transform(st_as_sfc(st_bbox(map_bbox, crs = 4326)), 3857))
  
 # Overwrite the bbox of the ggmap object with the transformed coordinates 
  attr(map, "bb")$ll.lat <- bbox_3857["ymin"]
  attr(map, "bb")$ll.lon <- bbox_3857["xmin"]
  attr(map, "bb")$ur.lat <- bbox_3857["ymax"]
  attr(map, "bb")$ur.lon <- bbox_3857["xmax"]
  map
}

map <- ggmap_bbox(map)

A = ggmap(map) + 
  coord_sf(crs = st_crs(3857)) + # force the ggplot2 map to be in 3857
  geom_sf(data = cam_3857$geometry, inherit.aes = FALSE) +
  labs(x = NULL, y = NULL) +
  theme(legend.position = "none",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
```

Next, the 2003 tornado
```{r}
Cam2 = Tor.sfdf[915,]
cam2_3857 <- st_transform(Cam2, 3857)

camilla2 <- c(left = -84.5000, bottom = 30.9000, right = -83.7571, top = 31.5000)
map <- get_stamenmap(camilla2, 
                     #zoom = 2, 
                     maptype = "toner", 
                     color = "bw")

# Define a function to fix the bbox to be in EPSG:3857
ggmap_bbox <- function(map) {
  if (!inherits(map, "ggmap")) stop("map must be a ggmap object")
  # Extract the bounding box (in lat/lon) from the ggmap to a numeric vector, 
  # and set the names to what sf::st_bbox expects:
  map_bbox <- setNames(unlist(attr(map, "bb")), 
                       c("ymin", "xmin", "ymax", "xmax"))

  # Coonvert the bbox to an sf polygon, transform it to 3857, 
  # and convert back to a bbox (convoluted, but it works)
  bbox_3857 <- st_bbox(st_transform(st_as_sfc(st_bbox(map_bbox, crs = 4326)), 3857))
  
 # Overwrite the bbox of the ggmap object with the transformed coordinates 
  attr(map, "bb")$ll.lat <- bbox_3857["ymin"]
  attr(map, "bb")$ll.lon <- bbox_3857["xmin"]
  attr(map, "bb")$ur.lat <- bbox_3857["ymax"]
  attr(map, "bb")$ur.lon <- bbox_3857["xmax"]
  map
}

map <- ggmap_bbox(map)

B = ggmap(map) + 
  coord_sf(crs = st_crs(3857)) + # force the ggplot2 map to be in 3857
  geom_sf(data = cam2_3857$geometry, inherit.aes = FALSE) +
  labs(x = NULL, y = NULL) +
  theme(legend.position = "none",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
```

Combine plots
```{r}
source("http://peterhaschke.com/Code/multiplot.R")
mat = matrix(c(1, 2), nrow = 1, byrow = TRUE)
A = A + ggtitle("A") + 
  theme(plot.title=element_text(hjust=0))
B = B + ggtitle("B") + 
  theme(plot.title=element_text(hjust=0))
multiplot(A, B, layout = mat)
```

### Find discrimination indices here (http://enceladus.isr.umich.edu/race/racestart.asp)

The model also overperditcs the Grovetown-Augusta, GA tornado (2009-04-10) by 65 casualties, while it underpredicts the Gainesville area, GA tornado (1998-03-20) by more than 100 casualties 174.

Demographics of Grovetown: 71\% white and 20\% black. Household median income at $33,382. The index of discrimination was 44.7.
Demographics of Augusta, GA: 39.1\% white and 54.7\% black. Household median income at $37,231. The index of discrimination was 44.7.

Demographics of Gainesville, GA: 54.2\% white and 15.2\% black (41.6\% hispanic or latino). Household median income at $38,119. The index of discrimination was 65.

The model overpredicts the Clinton-Jackson, MS tornado (2011-04-15) by 44 casualties, while the model underpredicts the Columbia, MS tornado (2014-12-23) by about the same amount (32).

Demographics for Clinton, MS: 60\% white and 33.9\% black. Household median income $56,539. The index of discrimination was 61.5.
Demographics for Jackson, MS: 18.4\% white and 79\% black. Household median income at $30,414. The index of discrimination was 61.5.

Demographics for Columbia, MS: 62.6\% whilte and 35.64\% black. Household median income at $19,644. The index of discrimination was 53.5. 

The largest underprediction in the model is the Tuscaloosa-Birmingam, AL tornado (2011-04-27) at 1,384 people.

The index of discrimination was 53.4 (Tuscaloosa Metro) and 70.3 (Birmingham Metro).

### Table of Over/Under-predicted casualties and covariates

Location & Date & Over/Under (Difference) & Index of Discrimination (0-100) \\

Grovetown-Augusta, GA & 2009-04-10 & Over (85) & 44.7 \\
Clinton-Jackson, MS & 2011-04-15 & Over (23) & 61.5 \\
Marion County, FL & 1995-01-07 & Over (6) & 49.6 \\
Van Wert, OH & 2002-11-10 & Over (19) & 37.0 \\
Waynesboro, TN & 2015-12-23 & Over (25) & 54.6 \\
Anderson Hills, AL & 1995-05-18 & Over (121) & 54.6 \\

Average Index of Discrimination: 50.3

Gainesville, GA & 1998-03-20 & Under (170) & 65.0 \\
Columbia, MS & 2014-12-23 & Under (30) & 53.5 \\
Tuscaloosa-Birmingam, AL & 2011-04-27 & Under (1115) & 61.9 \\
Arab-Joppa, AL & 1995-02-16 & Under (94) & 54.6 \\
Murfreesboro, TN & 2002-04-28 & Under (24) & 57.4 \\
Rowlett, TX & 2015-12-26 & Under (421) & 59.8 \\

Average Index of Discrimination: 58.7

Map of the top 10 underpredicted tornadoes
```{r}
#download.file("http://www2.census.gov/geo/tiger/GENZ2015/shp/cb_2015_us_state_20m.zip", destfile = "states.zip")
#unzip("states.zip")

us_geo <- read_shape("cb_2015_us_state_20m.shp", as.sf = TRUE, stringsAsFactors = FALSE)
us_geo = subset(us_geo, !(NAME %in% c("Alaska", "Hawaii", "Puerto Rico")))
colnames(us_geo)[5] = "st"

us_geo = us_geo %>%
  dplyr::select("st", "NAME" ,"geometry")

df3 = df2 %>%
  arrange(desc(differ))

df3 = df3[1:20,]

A = tm_shape(us_geo, projection ="+init=epsg:2163") +
  tm_borders() +
  tm_shape(df3) +
  tm_bubbles("differ", col = "#31a354", sizes.legend = c(200, 600, 1000, 1400), alpha = 0.3, title.size="Underpredicted Casualties", scale = 5/3) + 
  tm_shape(us_geo) + 
  tm_borders(col = "grey", alpha = 0.3) +
  tm_format_Europe(legend.position = c("left", "bottom"),
                   attr.position = c("left", "bottom"),
                   legend.frame = FALSE) +
  tm_layout(frame = FALSE)

df4 = df2 %>%
  arrange(differ) %>%
  mutate(differ = abs(differ))

df4 = df4[1:20,]

B = tm_shape(us_geo, projection ="+init=epsg:2163") +
  tm_borders() +
  tm_shape(df4) +
  tm_bubbles("differ", col = "purple", sizes.legend = c(50, 100, 150, 200), alpha = 0.3, title.size="Overpredicted Casualties", scale = 2/3) + 
  tm_shape(us_geo) + 
  tm_borders(col = "grey", alpha = 0.3) +
  tm_format_Europe(legend.position = c("left", "bottom"),
                   attr.position = c("left", "bottom"),
                   legend.frame = FALSE) +
  tm_layout(frame = FALSE)

A = A + tm_style_white(title="A")
B = B + tm_style_white(title="B")

tmap_arrange(A, B, ncol = 1)
```

Plot the residuals
```{r}
plot(residuals(model))
```

### Sankey Flow Chart

Sankey flow chart
```{r}
df = Torn.df %>%
  mutate(ratioW = WhitePeople/TotalPeople,
         ratioB = BlackPeople/TotalPeople,
         WhiteCas = round(cas * ratioW),
         BlackCas = round(cas * ratioB))

sigmoid <- function(x_from, x_to, y_from, y_to, scale = 5, n = 100) {
  x <- seq(-scale, scale, length = n)
  y <- exp(x) / (exp(x) + 1)
  tibble(x = (x + scale) / (scale * 2) * (x_to - x_from) + x_from,
         y = y * (y_to - y_from) + y_from)
}

n_points <- 400
data <- tibble(from = rep(4, n_points),
               to = sample(1:4, n_points, TRUE),
               color = sample(c("A", "B"), n_points, TRUE)) 

sigmoid(0, 1, as.numeric(data[2, 1]), as.numeric(data[2, 2]), 
        n = 100, scale = 10) %>%
  ggplot(aes(x, y)) +
  geom_point()

p = sigmoid(0, 1, as.numeric(data[2, 1]), as.numeric(data[2, 2]),
             n = 100, scale = 10) %>%
  mutate(time = row_number()) %>%
  ggplot(aes(x, y, frame = time)) +
  geom_point()

gganimate(p)
```
